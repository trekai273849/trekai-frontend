<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-TJDWMQZV');</script>
  <!-- End Google Tag Manager -->

  <meta charset="UTF-8" />
  <title>My Saved Itineraries | Smart Trails</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles/main.css" />
</head>
<body class="bg-gray-50 text-gray-800">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TJDWMQZV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <!-- Hero Header -->
  <header class="relative bg-cover bg-center h-48 flex items-center justify-center text-white" style="background-image: url('Images/alps.jpg');">
    <a href="index.html" class="absolute top-4 left-6 text-white text-xl font-bold">Smart Trails</a>
    <div class="bg-black bg-opacity-50 p-6 rounded-lg">
      <h1 class="text-3xl font-bold mb-2">My Saved Itineraries</h1>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-5xl mx-auto p-6">
    <div id="auth-status" class="mb-6">
      <p class="text-center text-gray-600">Checking authentication status...</p>
    </div>
    
    <div id="itineraries-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
      <!-- Itineraries will be loaded here -->
    </div>

    <div id="no-itineraries" class="text-center py-10 hidden">
      <p class="text-xl text-gray-600 mb-4">You don't have any saved itineraries yet.</p>
      <a href="index.html" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-md inline-block">Create an Itinerary</a>
    </div>
  </main>

  <!-- Scripts -->
  <script type="module">
    import { auth } from './js/auth/firebase.js';
    import { getCurrentUser, logOut } from './js/auth/auth.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

    // Check if user is logged in
    onAuthStateChanged(auth, (user) => {
      const authStatusDiv = document.getElementById('auth-status');
      
      if (user) {
        // User is signed in
        authStatusDiv.innerHTML = `
          <div class="flex justify-between items-center mb-8">
            <p class="text-gray-700">Signed in as: <span class="font-semibold">${user.email}</span></p>
            <div>
              <button id="logout-btn" class="text-red-600 hover:text-red-800 mr-4">Sign Out</button>
              <a href="index.html" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">Create New Itinerary</a>
            </div>
          </div>
        `;
        
        // Add logout functionality
        document.getElementById('logout-btn').addEventListener('click', async () => {
          const result = await logOut();
          if (result.success) {
            window.location.href = 'index.html';
          } else {
            console.error('Sign out error:', result.error);
          }
        });
        
        // Fetch user's itineraries
        fetchItineraries(user);
      } else {
        // User is not signed in
        authStatusDiv.innerHTML = `
          <div class="text-center py-8">
            <p class="text-xl text-gray-700 mb-4">Please sign in to view your saved itineraries.</p>
            <a href="sign-up.html" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-md inline-block">Sign In</a>
          </div>
        `;
      }
    });

    // Function to fetch itineraries
    async function fetchItineraries(user) {
      try {
        // First check if the API health endpoint is responding
        try {
          const healthResponse = await fetch('https://trekai-api.onrender.com/api/health');
          const healthData = await healthResponse.json();
          if (healthData.status !== 'ok') {
            throw new Error(`API health check failed: ${healthData.message}`);
          }
        } catch (healthError) {
          console.error('API health check error:', healthError);
          // Continue anyway - we'll try the main request
        }

        // Get fresh token
        const token = await user.getIdToken(true);
        
        const response = await fetch('https://trekai-api.onrender.com/api/itineraries', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/json'
          }
        });
        
        if (!response.ok) {
          if (response.status === 401 || response.status === 403) {
            throw new Error('Authentication failed. Please sign out and sign in again.');
          } else if (response.status === 500) {
            throw new Error('The server is currently experiencing issues. Please try again later.');
          } else {
            throw new Error(`Server responded with status: ${response.status}`);
          }
        }
        
        const itineraries = await response.json();
        
        if (itineraries.length === 0) {
          document.getElementById('no-itineraries').classList.remove('hidden');
        } else {
          const container = document.getElementById('itineraries-container');
          container.classList.remove('hidden');
          
          itineraries.forEach(itinerary => {
            // Create a date formatter
            const dateFormatter = new Intl.DateTimeFormat('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric'
            });
            
            // Format the date
            const createdDate = dateFormatter.format(new Date(itinerary.createdAt));
            
            // Create card for itinerary
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-md overflow-hidden';
            card.innerHTML = `
              <div class="h-32 bg-blue-100 flex items-center justify-center bg-cover bg-center" style="background-image: url('Images/alps.jpg')">
                <h3 class="text-xl font-bold p-4 bg-black bg-opacity-50 text-white rounded">${itinerary.location}</h3>
              </div>
              <div class="p-4">
                <h4 class="font-bold text-lg mb-2">${itinerary.title}</h4>
                <p class="text-gray-600 text-sm mb-3">Created: ${createdDate}</p>
                <div class="flex flex-wrap gap-2 mb-4">
                  ${itinerary.filters.difficulty ? `<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">${itinerary.filters.difficulty}</span>` : ''}
                  ${itinerary.filters.accommodation ? `<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">${itinerary.filters.accommodation}</span>` : ''}
                  ${itinerary.filters.technical ? `<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">${itinerary.filters.technical}</span>` : ''}
                </div>
                <div class="flex justify-between">
                  <a href="view-itinerary.html?id=${itinerary._id}" class="text-blue-600 hover:text-blue-800">View</a>
                  <button class="text-red-600 hover:text-red-800 delete-btn" data-id="${itinerary._id}">Delete</button>
                </div>
              </div>
            `;
            
            container.appendChild(card);
          });
          
          // Add delete functionality
          document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              if (confirm('Are you sure you want to delete this itinerary?')) {
                const itineraryId = e.target.dataset.id;
                try {
                  const token = await user.getIdToken();
                  
                  const response = await fetch(`https://trekai-api.onrender.com/api/itineraries/${itineraryId}`, {
                    method: 'DELETE',
                    headers: {
                      'Authorization': `Bearer ${token}`
                    }
                  });
                  
                  if (!response.ok) throw new Error('Failed to delete itinerary');
                  
                  // Remove the card from the DOM
                  e.target.closest('.bg-white').remove();
                  
                  // Check if there are any itineraries left
                  if (container.children.length === 0) {
                    document.getElementById('no-itineraries').classList.remove('hidden');
                    container.classList.add('hidden');
                  }
                } catch (error) {
                  console.error('Error deleting itinerary:', error);
                  alert('Failed to delete itinerary. Please try again.');
                }
              }
            });
          });
        }
      } catch (error) {
        console.error('Error fetching itineraries:', error);
        const authStatusDiv = document.getElementById('auth-status');
        authStatusDiv.innerHTML += `
          <div class="bg-red-100 text-red-700 p-4 rounded-md">
            <p>Failed to load itineraries. Please try again later.</p>
            <p class="text-sm mt-2">${error.message}</p>
            <button id="retry-btn" class="mt-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md">Retry</button>
          </div>
        `;
        
        // Add retry button functionality
        document.getElementById('retry-btn')?.addEventListener('click', () => {
          window.location.reload();
        });
      }
    }
  </script>
  <script src="js/components/navbar.js" type="module"></script>
</body>
</html>