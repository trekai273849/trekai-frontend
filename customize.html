<!DOCTYPE html>
<html lang="en">
<head>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-TJDWMQZV');</script>
  <meta charset="UTF-8" />
  <title>Your Custom Trek Itinerary - Smart Trails</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="styles/main.css" />
  <style>
    /* All of your existing CSS remains here, unchanged */
    :root { --primary: #2D5016; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
    .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%); display: none; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.6s ease; }
    .loading-overlay.active { display: flex; }
    .loading-overlay.fade-out { opacity: 0; }
    /* ... etc. ... */
  </style>
</head>
<body>
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TJDWMQZV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

  <main class="main-content-area">
    <div id="itinerary-cards"></div>
  </main>
  
  <div class="loading-overlay active" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-animation">
        <div class="loading-circle loading-circle-outer"></div>
        <div class="loading-circle loading-circle-inner"></div>
        <div class="loading-icon">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 6l-3.75 5 2.85 3.8-1.6 1.2C9.81 13.75 7 10 7 10l-6 8h22l-9-12z"/></svg>
        </div>
      </div>
      <h2 class="loading-title">Crafting Your Perfect Trek</h2>
      <p class="loading-subtitle">Just a moment while we build your adventure...</p>
    </div>
  </div>

  <div id="footer-container"></div>

  <script src="js/components/navbar.js" type="module"></script>
  <script src="js/components/footer.js" type="module"></script>
  
  <script type="module">
    // 1. IMPORT the external service
    import { AdaptivePackingListGenerator } from './js/services/packingListService.js';

    // 2. DEFINE all constants and helper functions
    const getApiBaseUrl = () => {
        const hostname = window.location.hostname;
        if (hostname === 'localhost' || hostname === '127.0.0.1') {
            return 'http://localhost:3001';
        } else {
            return 'https://trekai-api.onrender.com';
        }
    };
    const API_BASE_URL = getApiBaseUrl();

    function mapQuizDataToInputs(quizData) {
        const tripStyleMapping = { '1-3': 'camping-short', '4-7': 'hut-trek', '8+': 'expedition', 'day-hike': 'day' };
        const terrainMapping = { 'mountains': 'alpine', 'forest': 'forest', 'coast': 'coastal', 'desert': 'desert', 'jungle': 'jungle', 'any': 'alpine' };
        const weatherMapping = { 'spring': 'sunny-cold', 'summer': 'sunny-warm', 'autumn': 'rainy', 'winter': 'snow' };
        const basic = {
            tripStyle: tripStyleMapping[quizData.length] || tripStyleMapping[quizData.trekType] || 'camping-short',
            terrain: terrainMapping[quizData.terrain] || 'alpine',
            weather: weatherMapping[quizData.season] || 'sunny-cold',
            specialNeeds: quizData.interests || []
        };
        const advanced = {
            temperature: { specified: false, dayHigh: null, nightLow: null },
            elevation: { specified: false, start: null, max: null, camp: null },
            physical: { specified: false, dailyDistance: '', elevationGain: '' },
            logistics: { specified: false, waterSources: '', resupplyFreq: '' },
            accommodation: { types: quizData.accommodation ? [quizData.accommodation] : [], specified: !!quizData.accommodation },
            activities: { photography: (quizData.interests || []).includes('photography'), wildlife: (quizData.interests || []).includes('wildlife'), specified: (quizData.interests || []).length > 0 },
            group: { specified: false, size: '', experience: '' },
            preferences: { specified: false, ultralight: false, comfort: false, safety: false, minimalist: false },
            context: ''
        };
        return { basic, advanced };
    }
    
    function renderPackingList(packingData) {
        const { items, metadata } = packingData;
        if (!items || metadata.totalItems === 0) return '';
        const categoryInfo = { clothing: { icon: 'üëï', name: 'Clothing' }, footwear: { icon: 'ü•æ', name: 'Footwear' }, camping: { icon: 'üèïÔ∏è', name: 'Camping & Shelter' }, navigation: { icon: 'üß≠', name: 'Navigation' }, safety: { icon: '‚õëÔ∏è', name: 'Safety & First Aid' }, personal: { icon: 'üß¥', name: 'Personal Care' }, food: { icon: 'üç≤', name: 'Food & Water' }, optional: { icon: '‚ú®', name: 'Optional Items' }};
        let categoriesHtml = '';
        for (const [category, categoryItems] of Object.entries(items)) {
            if (categoryItems.length > 0) {
                categoriesHtml += `<div><div class="font-bold text-lg mb-2">${categoryInfo[category]?.icon || '‚úîÔ∏è'} ${categoryInfo[category]?.name || category}</div><ul class="space-y-1">${categoryItems.map(item => `<li class="text-gray-700 border-b border-gray-100 py-1">${item.name} ${item.quantity ? `(${item.quantity})` : ''}</li>`).join('')}</ul></div>`;
            }
        }
        return `<div class="info-card" id="packing-list-section"><h3 class="flex items-center gap-4 text-2xl font-bold mb-6"><i class="fas fa-clipboard-list text-green-600"></i>Your Custom Packing List</h3><div class="grid md:grid-cols-2 gap-8">${categoriesHtml}</div></div>`;
    }

    function renderAiResponse(responseText) {
        const sections = responseText.split(/(?=###\s)/g).filter(Boolean);
        let html = '';
        if (sections.length > 0 && !sections[0].startsWith('###')) {
            const intro = sections.shift().trim();
            html += `<div class="info-card enhanced-content">${intro.replace(/\n{2,}/g, '<br><br>').replace(/\n/g, '<br>')}</div>`;
        }
        for (const section of sections) {
            const lines = section.trim().split('\n');
            const title = lines.shift().replace('###', '').trim();
            let content = lines.join('\n').trim();
            content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/^- (.*$)/gm, '<li class="ml-4 list-disc">$1</li>').replace(/\n/g, '<br>');
            let iconClass = 'fa-info-circle';
            if (title.toLowerCase().includes('day')) iconClass = 'fa-calendar-day';
            if (title.toLowerCase().includes('insights')) iconClass = 'fa-lightbulb';
            if (title.toLowerCase().includes('practical')) iconClass = 'fa-cogs';
            html += `<div class="info-card"><h3 class="flex items-center gap-4 text-2xl font-bold mb-4"><i class="fas ${iconClass} text-blue-600"></i>${title}</h3><div class="enhanced-content">${content}</div></div>`;
        }
        return html;
    }

    function startLoadingAnimation() {
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) loadingOverlay.classList.add('active');
    }

    function stopLoadingAnimation() {
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.classList.add('fade-out');
            setTimeout(() => {
                loadingOverlay.classList.remove('active');
                loadingOverlay.classList.remove('fade-out');
                document.getElementById('itinerary-cards')?.classList.add('show');
            }, 600);
        }
    }

    // 3. MAIN ORCHESTRATION FUNCTION
    async function generateAndDisplayItinerary(quizData) {
        try {
            console.log('Generating itinerary from quiz data:', quizData);

            const { basic, advanced } = mapQuizDataToInputs(quizData);
            const generator = new AdaptivePackingListGenerator(basic, advanced);
            const packingData = generator.generate();
            console.log('‚úÖ Packing list generated locally.');

            const response = await fetch(`${API_BASE_URL}/api/finalize`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    location: quizData.location,
                    filters: { difficulty: quizData.difficulty, accommodation: quizData.accommodation, duration: quizData.length, season: quizData.season },
                    comments: `Key interests: ${(quizData.interests || []).join(', ')}`,
                    title: `${quizData.location || 'Custom'} Trek Itinerary`
                })
            });

            if (!response.ok) throw new Error(`API call failed with status ${response.status}`);
            const itineraryData = await response.json();
            if (!itineraryData.reply) throw new Error('API response was empty.');
            
            console.log('‚úÖ AI itinerary text received.');

            const itineraryHtml = renderAiResponse(itineraryData.reply);
            const packingListHtml = renderPackingList(packingData);
            document.getElementById('itinerary-cards').innerHTML = itineraryHtml + packingListHtml;

        } catch (error) {
            console.error('Failed to generate full itinerary:', error);
            document.getElementById('itinerary-cards').innerHTML = `<div class="info-card text-center"><h3 class="text-red-600 text-2xl font-bold mb-4">Oops! Something Went Wrong</h3><p>We couldn't generate your itinerary. Please check your connection and ensure the backend server is running.</p><a href="index.html" class="mt-4 inline-block bg-blue-600 text-white px-6 py-2 rounded">Go Back Home</a></div>`;
        }
    }

    // 4. INITIALIZE ON PAGE LOAD
    document.addEventListener('DOMContentLoaded', async () => {
      startLoadingAnimation();
      const quizDataStr = localStorage.getItem('quizData');
      
      if (!quizDataStr) {
        console.error('No quiz data found, redirecting to home.');
        window.location.href = 'index.html';
        return;
      }
      
      try {
        const quizData = JSON.parse(quizDataStr);
        localStorage.removeItem('quizData');
        await generateAndDisplayItinerary(quizData);
      } catch (error) {
        console.error('Error on page load:', error);
      } finally {
        stopLoadingAnimation();
      }
    });
  </script>

</body>
</html>