<!DOCTYPE html>
<html lang="en">
<head>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-TJDWMQZV');</script>
  <meta charset="UTF-8" />
  <title>Your Custom Trek Itinerary - Smart Trails</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="styles/main.css" />
  
  <style>
    /* CSS Variables for consistent theming */
    :root {
      --primary: #2D5016;
      --primary-light: #4A7C28;
      --primary-lighter: #6B9A3C;
      --accent: #F39C12;
      --orange: #F39C12;
      --text-dark: #2C3E50;
      --text-light: #5D6D7E;
      --bg-light: #F8F9FA;
      --white: #FFFFFF;
      --shadow: rgba(0, 0, 0, 0.1);
      --success: #27AE60;
      --warning: #E74C3C;
      --info: #3498DB;
      --text-primary: #222222;
      --text-secondary: #717171;
      --border: #DDDDDD;
      --background-secondary: #F7F7F7;
      --radius: 12px;
      --radius-sm: 8px;
      --shadow-sm: rgba(0, 0, 0, 0.04) 0px 6px 16px;
      --shadow-md: rgba(0, 0, 0, 0.12) 0px 6px 16px;
      --shadow-lg: rgba(0, 0, 0, 0.12) 0px 6px 20px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--bg-light);
    }

    /* Main content area */
    .main-content-area {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    /* Professional Loading State */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: opacity 0.6s ease;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-overlay.fade-out {
      opacity: 0;
    }

    .loading-content {
      text-align: center;
      max-width: 600px;
      padding: 40px;
      background: white;
      border-radius: 24px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
      animation: contentFadeIn 0.6s ease;
    }

    @keyframes contentFadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Professional Loading Animation */
    .loading-animation {
      width: 120px;
      height: 120px;
      margin: 0 auto 40px;
      position: relative;
    }

    .loading-circle {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
    }

    .loading-circle-outer {
      border: 3px solid #e9ecef;
      animation: pulse 2s ease-in-out infinite;
    }

    .loading-circle-inner {
      border: 3px solid transparent;
      border-top-color: var(--primary);
      animation: rotate 1.5s linear infinite;
    }

    .loading-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(45, 80, 22, 0.2);
    }

    .loading-icon svg {
      width: 28px;
      height: 28px;
      fill: white;
    }

    @keyframes rotate {
      to { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% { 
        transform: scale(1);
        opacity: 1;
      }
      50% { 
        transform: scale(1.1);
        opacity: 0.5;
      }
    }

    /* Progress Steps */
    .loading-progress {
      display: flex;
      justify-content: space-between;
      margin-bottom: 40px;
      position: relative;
    }

    .loading-progress::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 60px;
      right: 60px;
      height: 2px;
      background: #e9ecef;
      z-index: 0;
    }

    .progress-line {
      position: absolute;
      top: 20px;
      left: 60px;
      right: 60px;
      height: 2px;
      background: var(--primary);
      transform-origin: left;
      transform: scaleX(0);
      transition: transform 5s ease;
      z-index: 1;
    }

    .loading-overlay.active .progress-line {
      animation: progressFill 20s ease-out;
    }

    @keyframes progressFill {
      0% { transform: scaleX(0); }
      25% { transform: scaleX(0.25); }
      50% { transform: scaleX(0.5); }
      75% { transform: scaleX(0.75); }
      100% { transform: scaleX(1); }
    }

    .progress-step {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      border: 2px solid #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.4s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .step-circle svg {
      width: 20px;
      height: 20px;
      stroke: #cbd5e1;
      stroke-width: 2;
      fill: none;
      transition: all 0.4s ease;
    }

    .progress-step.active .step-circle {
      border-color: var(--primary);
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(45, 80, 22, 0.3);
    }

    .progress-step.active .step-circle svg {
      stroke: var(--primary);
    }

    .progress-step.completed .step-circle {
      background: var(--primary);
      border-color: var(--primary);
    }

    .progress-step.completed .step-circle svg {
      stroke: white;
      fill: white;
    }

    .step-label {
      font-size: 13px;
      color: #94a3b8;
      font-weight: 500;
      text-align: center;
      transition: color 0.4s ease;
    }

    .progress-step.active .step-label {
      color: var(--primary);
      font-weight: 600;
    }

    .progress-step.completed .step-label {
      color: var(--text-primary);
    }

    /* Loading Text */
    .loading-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 12px;
    }

    .loading-subtitle {
      font-size: 16px;
      color: var(--text-secondary);
      margin-bottom: 32px;
    }

    /* Trek Facts */
    .trek-fact-card {
      background: linear-gradient(135deg, #f0f7ed 0%, #e8f5e9 100%);
      border: 1px solid #d4e4d0;
      border-radius: 16px;
      padding: 20px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 32px;
      min-height: 80px;
      transition: all 0.4s ease;
    }

    .fact-icon-wrapper {
      width: 48px;
      height: 48px;
      background: white;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(45, 80, 22, 0.1);
    }

    .fact-icon-wrapper svg {
      width: 24px;
      height: 24px;
      fill: var(--primary);
    }

    .trek-fact-text {
      font-size: 15px;
      color: var(--text-primary);
      line-height: 1.6;
      text-align: left;
      opacity: 0;
      animation: factFadeIn 0.6s ease forwards;
    }

    @keyframes factFadeIn {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Results Container */
    #itinerary-cards {
      opacity: 0;
      transform: translateY(30px);
      transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      z-index: 10;
    }

    #itinerary-cards.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* Additional Sections Cards (used for rendering) */
    .info-card {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 4px 20px var(--shadow);
      margin-bottom: 30px;
    }

    .info-card h3 {
      font-size: 1.8em;
      margin-bottom: 25px;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .enhanced-content {
      color: var(--text-secondary);
      line-height: 1.8;
    }
    
    .enhanced-content strong {
        color: var(--text-dark);
        font-weight: 600;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TJDWMQZV"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <main class="main-content-area">
    <div id="itinerary-cards"></div>
  </main>
  
  <div class="loading-overlay active" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-animation">
        <div class="loading-circle loading-circle-outer"></div>
        <div class="loading-circle loading-circle-inner"></div>
        <div class="loading-icon">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 6l-3.75 5 2.85 3.8-1.6 1.2C9.81 13.75 7 10 7 10l-6 8h22l-9-12z"/></svg>
        </div>
      </div>
      <div class="loading-progress">
        <div class="progress-line"></div>
        <div class="progress-step active" data-stage="1"><div class="step-circle"><svg viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z" /></svg></div><div class="step-label">Analyzing preferences</div></div>
        <div class="progress-step" data-stage="2"><div class="step-circle"><svg viewBox="0 0 24 24"><path d="M12,2C17.53,2 22,6.47 22,12C22,17.53 17.53,22 12,22C6.47,22 2,17.53 2,12C2,6.47 6.47,2 12,2M15.59,7L12,10.59L8.41,7L7,8.41L10.59,12L7,15.59L8.41,17L12,13.41L15.59,17L17,15.59L13.41,12L17,8.41L15.59,7Z" /></svg></div><div class="step-label">Finding trails</div></div>
        <div class="progress-step" data-stage="3"><div class="step-circle"><svg viewBox="0 0 24 24"><path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z" /></svg></div><div class="step-label">Planning stays</div></div>
        <div class="progress-step" data-stage="4"><div class="step-circle"><svg viewBox="0 0 24 24"><path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z" /></svg></div><div class="step-label">Finalizing details</div></div>
      </div>
      <h2 class="loading-title">Crafting Your Perfect Trek</h2>
      <p class="loading-subtitle">It can take up to a minute to create an adventure just for you</p>
      <div class="trek-fact-card">
        <div class="fact-icon-wrapper"><svg viewBox="0 0 24 24"><path d="M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" /></svg></div>
        <div class="trek-fact-text" id="hikingFact">Did you know? The Appalachian Trail spans 2,190 miles across 14 states!</div>
      </div>
    </div>
  </div>

  <div id="footer-container"></div>

  <script src="js/components/navbar.js" type="module"></script>
  <script src="js/components/footer.js" type="module"></script>
  
  <script type="module">
    // 1. IMPORT the service
    import { AdaptivePackingListGenerator } from './js/services/packingListService.js';

    // ✅ FIX 1: Define the absolute URL for your backend server.
    // Use the port your Node.js server is running on.
    const API_BASE_URL = 'http://localhost:3001';

    // 2. RENDERING FUNCTIONS
    
    /**
     * Renders the locally-generated packing list into a styled HTML string.
     */
    function renderPackingList(packingData) {
      const { items, metadata } = packingData;
      if (!items || metadata.totalItems === 0) return '';

      const categoryInfo = {
        clothing: { icon: '👕', name: 'Clothing' },
        footwear: { icon: '🥾', name: 'Footwear' },
        camping: { icon: '🏕️', name: 'Camping & Shelter' },
        navigation: { icon: '🧭', name: 'Navigation' },
        safety: { icon: '⛑️', name: 'Safety & First Aid' },
        personal: { icon: '🧴', name: 'Personal Care' },
        food: { icon: '🍲', name: 'Food & Water' },
        optional: { icon: '✨', name: 'Optional Items' }
      };

      let categoriesHtml = '';
      for (const [category, categoryItems] of Object.entries(items)) {
        if (categoryItems.length > 0) {
          categoriesHtml += `
            <div>
              <div class="font-bold text-lg mb-2">${categoryInfo[category]?.icon || '✔️'} ${categoryInfo[category]?.name || category}</div>
              <ul class="space-y-1">
                ${categoryItems.map(item => `<li class="text-gray-700 border-b border-gray-100 py-1">${item.name} ${item.quantity ? `(${item.quantity})` : ''}</li>`).join('')}
              </ul>
            </div>
          `;
        }
      }

      return `
        <div class="info-card" id="packing-list-section">
          <h3 class="flex items-center gap-4 text-2xl font-bold mb-6">
            <i class="fas fa-clipboard-list text-green-600"></i>
            Your Custom Packing List
          </h3>
          <div class="grid md:grid-cols-2 gap-8">
            ${categoriesHtml}
          </div>
        </div>
      `;
    }

    /**
     * Parses the AI's markdown-like response into structured HTML cards.
     */
    function renderAiResponse(responseText) {
      const sections = responseText.split(/(?=###\s)/g).filter(Boolean);
      let html = '';

      if (sections.length > 0 && !sections[0].startsWith('###')) {
        const intro = sections.shift().trim();
        html += `<div class="info-card enhanced-content">${intro.replace(/\n{2,}/g, '<br><br>').replace(/\n/g, '<br>')}</div>`;
      }
      
      for (const section of sections) {
          const lines = section.trim().split('\n');
          const title = lines.shift().replace('###', '').trim();
          let content = lines.join('\n').trim();

          content = content
              .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
              .replace(/\*(.*?)\*/g, '<em>$1</em>')
              .replace(/^- (.*$)/gm, '<li class="ml-4 list-disc">$1</li>')
              .replace(/\n/g, '<br>');

          let iconClass = 'fa-info-circle';
          if (title.toLowerCase().includes('day')) iconClass = 'fa-calendar-day';
          if (title.toLowerCase().includes('insights')) iconClass = 'fa-lightbulb';
          if (title.toLowerCase().includes('practical')) iconClass = 'fa-cogs';

          html += `
            <div class="info-card">
              <h3 class="flex items-center gap-4 text-2xl font-bold mb-4"><i class="fas ${iconClass} text-blue-600"></i>${title}</h3>
              <div class="enhanced-content">${content}</div>
            </div>
          `;
      }

      return html;
    }

    /**
     * Maps the quiz data structure to the format expected by the packing list service.
     */
    function mapQuizDataToInputs(quizData) {
    const tripStyleMapping = {
        '1-3': 'camping-short', '4-7': 'hut-trek', '8+': 'expedition', 'day-hike': 'day'
    };
    const terrainMapping = {
        'mountains': 'alpine', 'forest': 'forest', 'coast': 'coastal', 'desert': 'desert', 'jungle': 'jungle', 'any': 'alpine'
    };
    const weatherMapping = {
        'spring': 'sunny-cold', 'summer': 'sunny-warm', 'autumn': 'rainy', 'winter': 'snow'
    };

    const basic = {
        tripStyle: tripStyleMapping[quizData.length] || tripStyleMapping[quizData.trekType] || 'camping-short',
        terrain: terrainMapping[quizData.terrain] || 'alpine',
        weather: weatherMapping[quizData.season] || 'sunny-cold',
        specialNeeds: quizData.interests || []
    };
    
    // ✅ FIX: Create the full structure for the 'advanced' object with default values.
    const advanced = {
        temperature: { specified: false, dayHigh: null, nightLow: null },
        elevation: { specified: false, start: null, max: null, camp: null },
        physical: { specified: false, dailyDistance: '', elevationGain: '' },
        logistics: { specified: false, waterSources: '', resupplyFreq: '' },
        accommodation: { 
            types: quizData.accommodation ? [quizData.accommodation] : [],
            specified: !!quizData.accommodation
        },
        activities: {
            photography: (quizData.interests || []).includes('photography'),
            specified: (quizData.interests || []).length > 0
        },
        group: { specified: false, size: '', experience: '' },
        preferences: { specified: false, ultralight: false, comfort: false, safety: false, minimalist: false },
        context: ''
    };

    return { basic, advanced };
}

    // 3. MAIN ORCHESTRATION FUNCTION
    async function generateAndDisplayItinerary(quizData) {
      try {
        console.log('Generating itinerary from quiz data:', quizData);

        // --- Step A: Generate Packing List Locally (Fast) ---
        // First, map the quiz data to the format the service expects
        const { basic, advanced } = mapQuizDataToInputs(quizData);
        // Then, instantiate the generator with the correct inputs
        const generator = new AdaptivePackingListGenerator(basic, advanced);
        const packingData = generator.generate();
        const packingListHtml = renderPackingList(packingData);
        console.log('✅ Packing list generated locally.');

        // --- Step B: Call AI for Itinerary Text (Slower) ---
        const response = await fetch(`${API_BASE_URL}/api/finalize`, { // ✅ FIX 1: Using the absolute URL
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            location: quizData.location,
            filters: {
              difficulty: quizData.difficulty,
              accommodation: quizData.accommodation,
              duration: quizData.length,
              season: quizData.season
            },
            comments: `Key interests: ${(quizData.interests || []).join(', ')}`,
            title: `${quizData.location || 'Custom'} Trek Itinerary`
          })
        });

        if (!response.ok) {
          const errorBody = await response.text();
          throw new Error(`API call failed with status ${response.status}: ${errorBody}`);
        }
        
        const itineraryData = await response.json();
        const itineraryText = itineraryData.reply;
        console.log('✅ AI itinerary text received.');

        // --- Step C: Combine and Render ---
        const itineraryHtml = renderAiResponse(itineraryText);
        const finalHtml = itineraryHtml + packingListHtml;
        
        document.getElementById('itinerary-cards').innerHTML = finalHtml;

      } catch (error) {
        console.error('Failed to generate full itinerary:', error);
        document.getElementById('itinerary-cards').innerHTML = `
          <div class="info-card text-center">
            <h3 class="text-red-600 text-2xl font-bold mb-4">Oops! Something Went Wrong</h3>
            <p>We couldn't generate your itinerary. This could be a connection issue or a server problem. Please try again later.</p>
            <a href="index.html" class="mt-4 inline-block bg-blue-600 text-white px-6 py-2 rounded">Go Back Home</a>
          </div>
        `;
      }
    }

    // 4. INITIALIZE ON PAGE LOAD
    document.addEventListener('DOMContentLoaded', async () => {
      startLoadingAnimation();
      
      const quizDataStr = localStorage.getItem('quizData');
      if (!quizDataStr) {
        console.error('No quiz data found, redirecting to home.');
        window.location.href = 'index.html';
        return;
      }

      try {
        const quizData = JSON.parse(quizDataStr);
        localStorage.removeItem('quizData'); 

        await generateAndDisplayItinerary(quizData);
        
      } catch (error) {
        console.error('Error on page load:', error);
      } finally {
        stopLoadingAnimation();
        transitionToItinerary();
      }
    });

  </script>

  <script>
    let stageInterval, factInterval, currentStage = 1;
    const hikingFacts = [
      "Did you know? The Appalachian Trail spans 2,190 miles across 14 states!",
      "Fun fact: Mount Everest grows about 4 millimeters each year due to geological forces.",
      "Hiking tip: The 'Leave No Trace' principles help preserve trails for future generations.",
      "Did you know? The Inca Trail to Machu Picchu limits visitors to 500 per day to protect the path.",
      "Trail wisdom: 'Cotton kills' - synthetic fabrics dry faster and keep you warmer when wet.",
      "Fun fact: The Pacific Crest Trail crosses through 7 national parks and 25 national forests."
    ];

    function startLoadingAnimation() { /* ... unchanged ... */ }
    function stopLoadingAnimation() { /* ... unchanged ... */ }
    function transitionToItinerary() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.classList.add('fade-out');
        setTimeout(() => {
          overlay.style.display = 'none';
          document.getElementById('itinerary-cards')?.classList.add('show');
        }, 600);
      }
    }
    // ... all other modal and UI helper functions remain unchanged ...
  </script>
</body>
</html>